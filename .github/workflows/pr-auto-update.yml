name: PRè‡ªå‹•æ›´æ–°ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]
  pull_request_review:
    types: [submitted]
  push:
    branches: [auto-implement-*]

jobs:
  pr-management:
    runs-on: ubuntu-latest
    if: startsWith(github.head_ref, 'auto-implement-') || contains(github.event.pull_request.labels.*.name, 'auto-implemented')
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Issueç•ªå·ã‚’æŠ½å‡º
      id: extract-issue
      run: |
        if [[ "${{ github.head_ref }}" =~ auto-implement-([0-9]+) ]]; then
          echo "issue_number=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
        else
          echo "issue_number=" >> $GITHUB_OUTPUT
        fi
    
    - name: PRã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
      uses: actions/github-script@v7
      with:
        script: |
          const issueNumber = '${{ steps.extract-issue.outputs.issue_number }}';
          if (!issueNumber) return;
          
          // PRã®çŠ¶æ…‹ã‚’å–å¾—
          const { data: pr } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number
          });
          
          // PRã®çŠ¶æ…‹ã«åŸºã¥ã„ã¦Issueã‚’æ›´æ–°
          let status = 'ğŸŸ¡ å®Ÿè£…ä¸­';
          let progress = 'Claude Codeã§ã®è©³ç´°å®Ÿè£…ãŒé€²è¡Œä¸­';
          
          if (pr.draft) {
            status = 'ğŸŸ  ãƒ‰ãƒ©ãƒ•ãƒˆ';
            progress = 'ãƒ‰ãƒ©ãƒ•ãƒˆçŠ¶æ…‹ - å®Ÿè£…ç¶™ç¶šä¸­';
          } else if (pr.mergeable_state === 'clean') {
            status = 'ğŸŸ¢ ãƒ¬ãƒ“ãƒ¥ãƒ¼æº–å‚™å®Œäº†';
            progress = 'ãƒãƒ¼ã‚¸å¯èƒ½çŠ¶æ…‹ - ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾…æ©Ÿä¸­';
          } else if (pr.mergeable_state === 'unstable') {
            status = 'ğŸŸ¡ ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­';
            progress = 'CI/CDãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­';
          } else if (pr.mergeable_state === 'dirty') {
            status = 'ğŸ”´ ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆ';
            progress = 'ãƒãƒ¼ã‚¸ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãŒç™ºç”Ÿ - è§£æ±ºãŒå¿…è¦';
          }
          
          // Issueã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
          await github.rest.issues.createComment({
            issue_number: parseInt(issueNumber),
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `ğŸ¤– **è‡ªå‹•å®Ÿè£…PRæ›´æ–°**
            
            **PR #${{ github.event.pull_request.number }}** ã®çŠ¶æ…‹ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ
            
            **ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:** ${status}
            **é€²æ—:** ${progress}
            
            ### PRè©³ç´°
            - **ãƒ–ãƒ©ãƒ³ãƒ:** \`${{ github.head_ref }}\`
            - **ã‚³ãƒŸãƒƒãƒˆæ•°:** ${{ github.event.pull_request.commits }}
            - **å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°:** ${{ github.event.pull_request.changed_files }}
            - **è¿½åŠ è¡Œæ•°:** +${{ github.event.pull_request.additions }}
            - **å‰Šé™¤è¡Œæ•°:** -${{ github.event.pull_request.deletions }}
            
            ### æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
            ${pr.draft ? '- ãƒ‰ãƒ©ãƒ•ãƒˆã‚’è§£é™¤ã—ã¦ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é–‹å§‹' : ''}
            ${pr.mergeable_state === 'clean' ? '- ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿæ–½' : ''}
            ${pr.mergeable_state === 'dirty' ? '- ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã‚’è§£æ±º' : ''}
            ${pr.mergeable_state === 'unstable' ? '- CI/CDã®çµæœã‚’ç¢ºèª' : ''}
            
            ---
            *ğŸ¤– è‡ªå‹•æ›´æ–° - ${new Date().toLocaleString('ja-JP', {timeZone: 'Asia/Tokyo'})}*`
          });
    
    - name: å®Ÿè£…é€²æ—ã‚’ãƒã‚§ãƒƒã‚¯
      uses: actions/github-script@v7
      with:
        script: |
          const { data: files } = await github.rest.pulls.listFiles({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number
          });
          
          // å®Ÿè£…ã®é€²æ—ã‚’ãƒã‚§ãƒƒã‚¯
          const implementedFiles = files.length;
          const pythonFiles = files.filter(f => f.filename.endsWith('.py')).length;
          const testFiles = files.filter(f => f.filename.includes('test')).length;
          const docFiles = files.filter(f => f.filename.endsWith('.md')).length;
          
          // å®Ÿè£…å®Œäº†åº¦ã‚’è¨ˆç®—
          let completionScore = 0;
          if (implementedFiles > 0) completionScore += 20;
          if (pythonFiles > 0) completionScore += 30;
          if (testFiles > 0) completionScore += 30;
          if (docFiles > 0) completionScore += 20;
          
          const completionPercentage = Math.min(completionScore, 100);
          
          // PRã®èª¬æ˜ã‚’æ›´æ–°
          const currentBody = context.payload.pull_request.body || '';
          const progressSection = `
          
          ---
          
          ## ğŸ¤– è‡ªå‹•å®Ÿè£…é€²æ—
          
          **å®Œäº†åº¦:** ${completionPercentage}%
          
          ### ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´çµ±è¨ˆ
          - **å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«:** ${implementedFiles}å€‹
          - **Pythonãƒ•ã‚¡ã‚¤ãƒ«:** ${pythonFiles}å€‹
          - **ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«:** ${testFiles}å€‹
          - **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:** ${docFiles}å€‹
          
          ### å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
          - [${implementedFiles > 0 ? 'x' : ' '}] åŸºæœ¬å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«
          - [${pythonFiles > 0 ? 'x' : ' '}] Pythonå®Ÿè£…
          - [${testFiles > 0 ? 'x' : ' '}] ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«
          - [${docFiles > 0 ? 'x' : ' '}] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
          
          *æœ€çµ‚æ›´æ–°: ${new Date().toLocaleString('ja-JP', {timeZone: 'Asia/Tokyo'})}*`;
          
          // æ—¢å­˜ã®é€²æ—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã—ã¦æ–°ã—ã„ã‚‚ã®ã‚’è¿½åŠ 
          const updatedBody = currentBody.replace(/---\n\n## ğŸ¤– è‡ªå‹•å®Ÿè£…é€²æ—[\s\S]*$/, '') + progressSection;
          
          await github.rest.pulls.update({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number,
            body: updatedBody
          });
    
    - name: ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã‚’è‡ªå‹•ã‚¢ã‚µã‚¤ãƒ³
      if: github.event.action == 'opened' && !github.event.pull_request.draft
      uses: actions/github-script@v7
      with:
        script: |
          // è‡ªå‹•å®Ÿè£…PRã®å ´åˆã€ãƒ¬ãƒ“ãƒ¥ãƒ¼æ‹…å½“è€…ã‚’è‡ªå‹•ã‚¢ã‚µã‚¤ãƒ³
          await github.rest.pulls.requestReviewers({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number,
            reviewers: ['${{ github.repository_owner }}'] // ãƒªãƒã‚¸ãƒˆãƒªã‚ªãƒ¼ãƒŠãƒ¼ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã«
          });
          
          // ãƒ¬ãƒ“ãƒ¥ãƒ¼æº–å‚™å®Œäº†ã®ã‚³ãƒ¡ãƒ³ãƒˆ
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `ğŸ¤– **è‡ªå‹•å®Ÿè£…PR - ãƒ¬ãƒ“ãƒ¥ãƒ¼æº–å‚™å®Œäº†**
            
            è‡ªå‹•å®Ÿè£…ãŒå®Œäº†ã—ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æº–å‚™ãŒæ•´ã„ã¾ã—ãŸã€‚
            
            ### ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚¤ãƒ³ãƒˆ
            - [ ] å®Ÿè£…ãƒ­ã‚¸ãƒƒã‚¯ã®ç¢ºèª
            - [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ç¢ºèª
            - [ ] ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®å¦¥å½“æ€§
            - [ ] ã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«ã®ç¢ºèª
            - [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ç¢ºèª
            
            ### Claude Codeã§ã®è¿½åŠ ä½œæ¥­
            å¿…è¦ã«å¿œã˜ã¦ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ä½œæ¥­ã‚’ç¶™ç¶šã§ãã¾ã™ï¼š
            \`\`\`bash
            git checkout ${{ github.head_ref }}
            claude code : auto-implementation-${{ steps.extract-issue.outputs.issue_number }}
            \`\`\`
            
            ---
            *ğŸ¤– è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ *`
          });
    
    - name: Issueã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
      uses: actions/github-script@v7
      with:
        script: |
          const issueNumber = '${{ steps.extract-issue.outputs.issue_number }}';
          if (!issueNumber) return;
          
          // PRãŒãƒãƒ¼ã‚¸ã•ã‚ŒãŸå ´åˆã€Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚º
          if (context.payload.pull_request.merged) {
            await github.rest.issues.createComment({
              issue_number: parseInt(issueNumber),
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸ‰ **è‡ªå‹•å®Ÿè£…å®Œäº†ï¼**
              
              PR #${{ github.event.pull_request.number }} ãŒãƒãƒ¼ã‚¸ã•ã‚Œã€å®Ÿè£…ãŒå®Œäº†ã—ã¾ã—ãŸã€‚
              
              ### å®Ÿè£…çµæœ
              - **å®Ÿè£…æ™‚é–“:** è‡ªå‹•å®Ÿè£…ã«ã‚ˆã‚‹é«˜é€Ÿå®Ÿè£…
              - **å“è³ª:** Claude Codeã«ã‚ˆã‚‹é«˜å“è³ªå®Ÿè£…
              - **ãƒ†ã‚¹ãƒˆ:** è‡ªå‹•ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ¸ˆã¿
              
              ã“ã® Issue ã¯è‡ªå‹•çš„ã«ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã¾ã™ã€‚
              
              ---
              *ğŸ¤– è‡ªå‹•å®Ÿè£…ã‚·ã‚¹ãƒ†ãƒ  - å®Œäº†*`
            });
            
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(issueNumber),
              state: 'closed'
            });
          }